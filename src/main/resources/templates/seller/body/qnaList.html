<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
<meta charset="UTF-8">
<title>Insert title here</title>
<link rel="stylesheet" th:href="@{/static/css/common.css}">
</head>
<body>
	<div class="container">
		<div class="title">QnA 목록</div>
		<div class="search-bar">
			<input type="text" placeholder="검색">
			<button type="button">검색</button>
			<select class="form-select w-auto col-md-4" aria-label="정렬">
					<option selected value="1">공연명↑</option>
					<option value="2">공연명↓</option>
					<option value="3">최신등록순</option>
					<option value="4">할인율순</option>
			</select>
		</div>
			<table>
				<thead >
				<tr>
                    <th>문의번호</th>
                    <th>사용자ID</th>
                    <th>공연명</th>
                    <th>문의날짜</th>
                    <th style="width: 40%;">문의제목</th>
                    <th>처리여부</th>
                    <th>답변</th>
                </tr>
				</thead>
				<tbody>
				<tr th:each="qna : ${qnaList}">
					<td th:text="${qna.qnaSeq}">문의번호</td>
					<td th:text="${qna.member.id}">사용자ID</td>
					<td th:text="${qna.play.name}">공연명</td>
					<td th:text="${qna.createdDate}">작성일</td>
					<td th:text="${qna.title}">제목</td>
					<td> 작업중 </td>
                  	<td ><button id="qnaReplyBtn" type="button"
                  				th:data-seq="${qna.qnaSeq}"
                  				data-bs-toggle="modal" 
								data-bs-target="#confirmModal"
								class="custom-btn">
							답변
						</button>
					</td>
                </tr>
                <tr>
                    <td>1651</td>
                    <td>example1</td>
			       	<td> 누가 죄인인가 </td>
                    <td> 2024.12.25 17:00 </td>
                    <td> 문의합니다 </td>
                   	<td class="text-center">
						  <div class="form-switch form-check d-flex justify-content-center">
						    <label class="form-check-label" for="toggle1"></label>
						    <input class="form-check-input" type="checkbox" id="toggle1">
						  </div>
					</td>
              		<td ><button id="qnaReplyBtn" type="button"
								data-bs-toggle="modal" 
								data-bs-target="#confirmModal"
								class="custom-btn"
								>답변</button>
					</td>
                </tr>
					<!-- 추가 행은 필요에 따라 추가 -->
				</tbody>
			</table>
		<div class="pagination">
			<a href="#">이전</a> <a href="#">1</a> <a href="#" class="active">2</a>
			<a href="#">3</a> <a href="#">4</a> <a href="#">5</a> <a href="#">다음</a>
		</div>
	</div>
	

	<!-- Modal -->
	<div class="modal fade" id="confirmModal" tabindex="-1" aria-labelledby="confirmModalLabel" aria-hidden="true">
	  <div class="modal-dialog">
	    <div class="modal-content">
	      <div class="modal-header">
	        <h5 class="modal-title" id="confirmModalLabel">Q&A 답변 </h5>
	        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
	      </div>
	      <div class="modal-body">
            <div class="mb-3">
                <label for="playName" class="form-label">공연명</label>
                <input type="text" class="form-control" id="playName" name= "playName" placeholder="공연명" readonly>
            </div>
            <div class="mb-3 row">
                <label for="memberName" class="form-label">작성자</label>
                <input type="text" class="form-control" id="memberName" name= "memberName" placeholder="작성자" readonly>
            </div>
            <div class="mb-3 row">
 	           <div class="col">
	                <label for="createdDate" class="form-label">작성일</label>
	                <input type="text" class="form-control" id="createdDate" name= "createdDate" placeholder="작성자" readonly> 
	           </div>
            </div>
            <div class="mb-3 row">
                <label for="title" class="form-label">제목</label>
                <input type="text" class="form-control" id="title" name= "title" placeholder="작성자" readonly>
            </div>
            <div class="mb-3">
            	<div class="col">
	                <label for="play_name" class="form-label">Q&A 내용</label>
	                <textarea class="form-control" id="content" name= "content" rows="4" placeholder="Q&A 내용" readonly> </textarea>
            	</div>
            </div>
            <div class="mb-3">
                <label for="replyContent" class="form-label">답변 작성 </label>
                <textarea  class="form-control" id="replyContent" name= replyContent rows="3" placeholder="답변 내용을 입력하세요" required > </textarea>
                <div class="invalid-feedback">답변 내용을 입력해 주세요.</div>
            </div>
          </div>
	      <div class="modal-footer">
	        <button type="button" class="custom-btn-disable" data-bs-dismiss="modal">취소</button>
	        <button type="button" class="custom-btn" id="confirmBtn">답변</button>
	      </div>
	    </div>
	  </div>
	</div>
<script>
$('#confirmBtn').on('show.bs.modal', function(event) {
	var button = $(event.relatedTarget); // 버튼을 클릭한 요소
	var seq = button.data('seq'); // data-seq 값 가져오기
	console.log(seq)
	$('#confirmBtn').data('seq', seq); // 삭제 버튼에 seq 값을 저장
});

// 삭제 버튼 클릭 시 서버에 삭제 요청 보내기
document.getElementById('confirmBtn').addEventListener('click', function() {
	
	var seq = $(this).data('seq'); // 저장된 seq 값을 가져오기

	$('#confirmModal').modal('hide');

    // 배경 회색 제거
    var backdrop = document.querySelector('.modal-backdrop');
    if (backdrop) {
        backdrop.remove();  // 배경을 수동으로 제거
    }
	// AJAX로 삭제 요청 보내기
	fetch(`/api/qnas/${seq}`, {
		method: 'DELETE',
		headers: {
			'Content-Type': 'application/json'
		}
	})
	.then(response => {
		if (response.ok) {
			showModal('답변이 등록 되었습니다.');
			 loadBodyForm('playList');
		} else {
			showModal('답변 등록이 실패했습니다.');
		}
	})
	.catch(error => {
		console.error('Error:', error);
		showModal('답변 등록이 실패했습니다.');
	});
});
function showModal(message) {
    // 메시지를 동적으로 설정
    document.getElementById('modalMessage').textContent = message;

    // 부트스트랩 모달 띄우기
    const Modal = new bootstrap.Modal(document.getElementById('Modal'));
    Modal.show();
}

$(document).on('click', '#qnaReplyBtn', function() {
    const qnaSeq =  $(this).data('seq'); // data-seq 가져오기
    console.log('선택된 QnA ID:', qnaSeq); // 디버깅	
    
    
	$.ajax({
		type: 'GET',
		url : `/api/qnas/qnaDetail/${qnaSeq}`,
		contentType : 'application/json',
		success : function(response) {
			$('#playName').val(response.playName);
			$('#memberName').val(response.memberName);
			$('#createdDate').val(response.createdDate);
			$('#title').val(response.title);
			$('#content').val(response.content);
		},
		error : function (error) {
			console.error('데이터를 가지고 오는데 실패했습니다.')
		}
		
	});//ajax
});//click qnaReplyBtn
    	
</script>
</body>
</html>